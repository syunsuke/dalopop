---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

```

# dalopop

<!-- badges: start -->
<!-- badges: end -->


dalopopは、大阪府の人口データを集めて活用するためのツールです。
大阪府のホームページで公表されている月次の人口データをダウンロードして、
SQLiteのデータベースファイルにするための関数を用意しています。また、データベースからデータをエクセルファイルでエクスポートしたり、レポートのエクスポートも出来ます。


![](https://github.com/user-attachments/assets/1c35d243-45d8-4d1d-a583-9466cc9b56c7)


このツールで利用するデータは、 大阪府が公表している
「[大阪府の毎月推計人口](https://www.pref.osaka.lg.jp/fuseiunei/toukeijouhou/toukeikajisshinochousa/maitsukisuikeijinkou/index.html)」に基づくものです。

URL:<https://www.pref.osaka.lg.jp/fuseiunei/toukeijouhou/toukeikajisshinochousa/maitsukisuikeijinkou/index.html>

当該データ自体のライセンスに関する明記はありませんが、
「[利用上の注意](https://www.pref.osaka.lg.jp/o040090/toukei/jinkou/jinkou-chuui.html)」のページがあるので目を通してください。


## インストール


まず、dalopopを利用するには、R以外に以下の準備が必要になります。

### SQLite

dalopopは、データベースSQLiteと連携して動くので、システムにSQLiteが必要です。

[https://www.sqlite.org/](https://www.sqlite.org/)


### JDK

更に、内部で利用する`XLConnect`パッケージは、JAVAの開発環境上で動くので、システムにJDK(JavaDeveplopmentKit)が必要になります。

JDKはどこのものでも構いません。うちでは、Eclipse TemurinのOpenJDKを利用(バージョンはJDK8)しています。

[https://adoptium.net/temurin](https://adoptium.net/temurin)


### Rの必要パッケージ

dalopopは、githubからインストールできます。
また、dalopopは、特に、`rabbit`パッケージと
`dalo`パッケージに依存しているので、以下のようにインストールします。
その他で必要になるパッケージは自動的にインストールされるはずです。

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("syunsuke/rabbit")
devtools::install_github("syunsuke/dalo")
devtools::install_github("syunsuke/dalopop")
```


## 使い方


### Rプロジェクト作成

人口データベースを管理するRプロジェクトを作ります。


### 準備

プロジェクトのフォルダ内に、大阪府の配布するエクセルファイルをキャッシュするディレクトリ、例えば、`excelfiles`を作ります。

次に、コマンドを順次実行するために、R Note等を作成しましょう。

そして、まずは、ライブラリの読み込み、そして、作成したエクセルファイルのキャッシュディレクトリ名と、作成するSQLiteデータベースのファイル名を定義します。


```{r, eval=FALSE}
library(dalopop)

# キャッシュ用ディレクトリを確保
dir <- "excelfilse"

# データベースのファイル名を決める
dbname <- "osaka_population.sqlite"
```



### 初期化

`dalopop_init_sqlite`コマンドで、データベースを作成して初期化。

但し、これは初めてデータベースを作成するときだけです。自分のフォルダ内に、既に`osaka_population.sqlite`ファイルがある場合は、実行する必要はありません。


```{r, eval=FALSE}
# データベースを作成
dalopop_init_sqlite(dbname)
```



### 管理

はじめて、データベースを作成したときには中身が空っぽです。

`dalopop_update_sqlite`コマンドで、データベースに人口情報を読み込んで、大阪府が公表している最新状態にアップデートしましょう。

コマンドの使い方は、キャッシュ用のディレクトリと、sqliteデータベースファイル名を引数に与えるだけです。


```{r, eval=FALSE}
# ファイルをダウンロードしてデータベースへ読み込む
dalopop_update_sqlite(dir_name = dir, 
                      dbname = dbname)
```


このアップデート関数は、自動的に大阪府のページからエクセルファイルをダウンロードし、そのエクセルファイルをSQLiteのデータベースに書き込んでくれます。

重複しているファイルは、ダウンロードされません。
また、既に書き込んだデータは、SQLiteに上書きされません。

大阪府は毎月データを公開しているので、公開されたらアップデートしましょう。



### エクスポート

`dalopop_export_excel`コマンドで、
比較的扱いやすいデータの形にして、
エクセルファイルとして出力できます。

エクセル等で簡易にデータを扱いたい場合は、この機能でデータをエクスポートしましょう。

```{r,eval=FALSE} 
dalopop_export_excel(dbname)
```

デフォルトでは大阪府下全てのデータをエクスポートします。

しかし、地域を選択することも出来ます。


```{r,eval=FALSE} 
# フィルタリングしたい市区町村名
myarea <- c("枚方市","寝屋川市","交野市","四條畷市","大東市")

# フィルタリングされたデータのみをエクスポート
dalopop_export_excel(dbname, areas = myarea)
```


また、その他のオプションとして、5歳区分別人口の区分をデフォルトの85歳から、95歳に変更できます。（但し、比較的新しい時点のもののみ）


```{r,eval=FALSE} 
dalopop_export_excel(dbname = dbname, 
                     age85 = FALSE, 
                     areas = myarea)
```


尚、エクスポートするファイル名は、`output`オプションで指定できます。

```{r,eval=FALSE} 
dalopop_export_excel(dbname = dbname, 
                     age85 = FALSE, 
                     areas = myarea,
                     output = "No9Bunkakai.xlsx"
                     )
```


## レポート

SQLiteのデータベースの地域名を与えることで、その地域の人口レポートを出力させることが出来ます。

また、複数地域名をベクトルで与えると、複数のレポートファイルを出力することが出来ます。

```{r,eval=FALSE} 
dalopop_report_by_excel(cities = c("枚方市","寝屋川市"),
                        db = dbname,
                        dir = "output/")
```



